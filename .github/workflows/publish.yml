name: Publish

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Version gate ────────────────────────────────────────────────
  check-version:
    name: Verify Tag ↔ Cargo.toml
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compare tag with Cargo.toml version
        run: |
          TAG="${GITHUB_REF_NAME}"
          WANT="${TAG#v}"
          GOT=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed 's/.*=\s*"\(.*\)".*/\1/')
          if [ "$GOT" != "$WANT" ]; then
            echo "::error::Version mismatch: Cargo.toml=$GOT tag=$TAG"
            exit 1
          fi

  # ── Cross-platform binaries ────────────────────────────────────
  build-binaries:
    name: Build ${{ matrix.artifact }}
    needs: [check-version]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: velka-linux-x86_64
            ext: ""
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: velka-linux-x86_64-musl
            ext: ""
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: velka-macos-x86_64
            ext: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: velka-macos-aarch64
            ext: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: velka-windows-x86_64
            ext: ".exe"
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          BIN="target/${{ matrix.target }}/release/velka${{ matrix.ext }}"
          cp "$BIN" "${{ matrix.artifact }}${{ matrix.ext }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}${{ matrix.ext }}

  # ── Publish to crates.io ───────────────────────────────────────
  publish-crates:
    name: Publish to crates.io
    needs: [check-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: publish
      - name: Publish
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  # ── GitHub Release with binaries ───────────────────────────────
  release-github:
    name: Create GitHub Release
    needs: [build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          for dir in artifacts/*/; do
            name=$(basename "$dir")
            file=$(ls "$dir" | head -1)
            cp "$dir/$file" "release-assets/$file"
            cd release-assets && sha256sum "$file" >> checksums-sha256.txt && cd ..
          done

      - name: Generate installer scripts
        run: |
          TAG="${GITHUB_REF_NAME}"
          REPO="wesllen-lima/velka"

          # Shell installer (Linux/macOS)
          cat > release-assets/velka-installer.sh << 'INSTALLER'
          #!/bin/sh
          set -eu
          REPO="wesllen-lima/velka"
          ARCH=$(uname -m)
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          case "$OS-$ARCH" in
            linux-x86_64)  ARTIFACT="velka-linux-x86_64" ;;
            linux-aarch64) ARTIFACT="velka-linux-x86_64-musl" ;;
            darwin-x86_64) ARTIFACT="velka-macos-x86_64" ;;
            darwin-arm64)  ARTIFACT="velka-macos-aarch64" ;;
            *) echo "Unsupported platform: $OS-$ARCH"; exit 1 ;;
          esac
          URL="https://github.com/${REPO}/releases/latest/download/${ARTIFACT}"
          INSTALL_DIR="${INSTALL_DIR:-/usr/local/bin}"
          echo "Downloading Velka for $OS/$ARCH..."
          curl -sL "$URL" -o "${INSTALL_DIR}/velka"
          chmod +x "${INSTALL_DIR}/velka"
          echo "Velka installed to ${INSTALL_DIR}/velka"
          velka --version
          INSTALLER
          chmod +x release-assets/velka-installer.sh

          # PowerShell installer (Windows)
          cat > release-assets/velka-installer.ps1 << 'PSINSTALLER'
          $ErrorActionPreference = 'Stop'
          $Repo = "wesllen-lima/velka"
          $Artifact = "velka-windows-x86_64.exe"
          $Url = "https://github.com/$Repo/releases/latest/download/$Artifact"
          $InstallDir = "$env:LOCALAPPDATA\velka"
          if (-not (Test-Path $InstallDir)) { New-Item -ItemType Directory -Path $InstallDir | Out-Null }
          Write-Host "Downloading Velka for Windows..."
          Invoke-WebRequest -Uri $Url -OutFile "$InstallDir\velka.exe"
          $Path = [Environment]::GetEnvironmentVariable("Path", "User")
          if ($Path -notlike "*$InstallDir*") {
            [Environment]::SetEnvironmentVariable("Path", "$Path;$InstallDir", "User")
            Write-Host "Added $InstallDir to PATH (restart terminal to use)"
          }
          Write-Host "Velka installed to $InstallDir\velka.exe"
          & "$InstallDir\velka.exe" --version
          PSINSTALLER

      - name: Extract changelog for this version
        id: changelog
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER="${TAG#v}"
          BODY=$(awk "/^## \\[${VER}\\]|^## ${VER}/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md 2>/dev/null || echo "Release ${TAG}")
          if [ -z "$BODY" ]; then
            BODY="Release ${TAG}"
          fi
          echo "body<<RELEASE_EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "RELEASE_EOF" >> $GITHUB_OUTPUT

      - name: Create or update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          artifacts: "release-assets/*"
          allowUpdates: true
          draft: false
          prerelease: false

